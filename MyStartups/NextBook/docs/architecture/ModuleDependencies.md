# NextBook Agent 模块依赖矩阵

此矩阵显示系统各模块间的依赖关系，有助于规划开发顺序和测试策略。

## 功能模块依赖

| 功能模块 | 依赖的功能模块              | 依赖的基础设施                   |
| -------- | --------------------------- | -------------------------------- |
| SAVE     | 无                          | 存储适配器, 文档适配器           |
| NEXT     | 可选: SAVE (阅读历史)       | AI适配器, 网络适配器, 存储适配器 |
| RECALL   | SAVE (需要已保存的内容)     | 存储适配器, AI适配器             |
| REPORT   | SAVE, NEXT, RECALL (数据源) | 存储适配器                       |

## 架构层依赖

| 架构层         | 依赖的架构层             | 测试策略               |
| -------------- | ------------------------ | ---------------------- |
| 用户界面层     | 应用服务层               | 组件测试, 模拟API响应  |
| 应用服务层     | 领域服务层, 事件总线     | 单元测试, 模拟领域服务 |
| 领域服务层     | 基础设施抽象层           | 单元测试, 模拟基础设施 |
| 基础设施抽象层 | 无(提供接口)             | 接口一致性测试         |
| 基础设施实现层 | 基础设施抽象层(实现接口) | 单元测试, 集成测试     |

## 开发与测试顺序建议

1. **第一阶段**: 基础设施抽象层 → 基础设施实现层(最小功能集) → 领域服务层
2. **第二阶段**: 应用服务层 → 用户界面层(基础组件)
3. **第三阶段**: SAVE模块集成 → RECALL模块集成
4. **第四阶段**: NEXT模块集成 → REPORT模块集成
5. **第五阶段**: 端到端测试与系统优化

## 关键接口

### 基础设施抽象层接口

这些接口是架构的关键点，需确保设计合理且稳定：

```python
# 存储适配器接口示例
class StorageAdapter:
    def save_content(self, content_data): pass
    def load_content(self, content_id): pass
    def search(self, query): pass
    def update(self, content_id, updates): pass
    def delete(self, content_id): pass
    # ...其他方法
```

### 事件接口

系统组件通过事件总线通信，关键事件包括：

```python
# 事件示例
class ContentImportedEvent:
    def __init__(self, content_id, metadata): pass
    
class ContentUpdatedEvent:
    def __init__(self, content_id, changes): pass
    
# ...其他事件
```

## 关键测试点

1. **组件隔离测试**: 每个架构层的组件应能独立测试
2. **替换性测试**: 确认基础设施实现可互换且不影响上层
3. **事件流测试**: 验证事件正确传播并触发预期行为
4. **跨模块集成测试**: 验证不同功能模块间的协作
5. **边缘情况测试**: 特别关注资源限制、网络问题、并发等场景
